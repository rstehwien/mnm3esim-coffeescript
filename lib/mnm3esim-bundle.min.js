// Generated by CoffeeScript 1.4.0
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h={}.hasOwnProperty,p=function(e,t){function r(){this.constructor=e}for(var n in t)h.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},d=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},v=function(e,t){return function(){return e.apply(t,arguments)}};s=require("./modifiable.coffee").Modifiable,u=require("../src/status.coffee").Status,t=function(e){function t(e){var n;e==null&&(e={}),n={attack:null,damage:0,damageImpervious:0,d20:0,roll:0,isCrit:!1,degree:-1},t.__super__.constructor.call(this,null,n,e),this.attack!=null&&(e.damage==null&&(this.damage=this.attack.rank),e.damageImpervious==null&&(this.damageImpervious=this.attack.rank))}return p(t,e),t}(s),e=function(e){function n(e){var t,r;e==null&&(e={}),t={bonus:10,rank:10},r={penetrating:0,minCrit:20,isCauseStress:!0,isPerceptionAttack:!1,isStatusRecovery:!1,isProgressive:!1,isMultiattack:!1,cumulativeStatuses:["staggered"],statuses:["dazed","staggered","incapacitated"]},n.__super__.constructor.call(this,t,r,e)}return p(n,e),n.DEFAULTS_DAMAGE={bonus:10,rank:10,penetrating:0,minCrit:20,isCauseStress:!0,isPerceptionAttack:!1,isStatusRecovery:!1,isProgressive:!1,isMultiattack:!1,cumulativeStatuses:["staggered"],statuses:["dazed","staggered","incapacitated"]},n.DEFAULTS_AFFLICTION={bonus:10,rank:10,penetrating:0,minCrit:20,isCauseStress:!1,isPerceptionAttack:!1,isStatusRecovery:!0,isProgressive:!1,isMultiattack:!1,cumulativeStatuses:[],statuses:["impaired","disabled","incapacitated"]},n.createDamage=function(e){return e==null&&(e={}),new n(c.extend(n.DEFAULTS_DAMAGE,e))},n.createAffliction=function(e){return e==null&&(e={}),new n(c.extend(n.DEFAULTS_AFFLICTION,e))},n.prototype.statusByResistDegree=function(e){return e>0?u.getStatus("normal"):this.statusByDegree(Math.abs(e))},n.prototype.statusByDegree=function(e){return e<1?u.getStatus("normal"):u.getStatus(this.statuses[Math.min(e,this.statuses.length)-1])},n.prototype.attack=function(e){var n;return n=new t({attack:this,degree:-1}),this.isPerceptionAttack?(n.degree=1,n):(n.d20=this.rollCheck(),n.roll=n.d20+this.bonus,n.d20===1?n:(n.degree=this.checkDegree(e.value+10,n.roll),n.isCrit=n.degree>0&&n.d20>=this.minCrit,n.d20===20&&n.degree<1&&(n.degree=1),n.degree<0?n:(n.isCrit&&(n.damage+=5,n.damageImpervious+=5),this.isMultiattack&&n.degree>1&&(n.damage+=n.degree>=3?5:2),n)))},n}(s),module.exports={Attack:e,AttackResult:t},s=require("./modifiable.coffee").Modifiable,l=require("./utils.coffee").utils,u=require("../src/status.coffee").Status,r=function(e){function t(e){var n;e==null&&(e={}),n={attack:null,defense:null,status:null,degree:null},t.__super__.constructor.call(this,null,n,e),e.degree==null&&e.status!=null&&(this.degree=e.status.degree),e.status==null&&e.attack!=null&&e.degree!=null&&(this.status=e.attack.statusByDegree(e.degree))}return p(t,e),t}(s),n=function(e){function t(e){var n,r;e==null&&(e={}),n={initiative:0,actions:"full",isControlled:!1,speed:0},r={name:"Character",attack:null,defense:null,stress:0,stressDegree:0,status:null,effects:{}},t.__super__.constructor.call(this,n,r,e),this.initCombat()}return p(t,e),t.prototype.initCombat=function(){return this.stress=0,this.actions="full",this.isControlled=!1,this.effects={},this.updateStatus(),this.initiativeValue=this.rollCheck(this.initiative)},t.prototype.updateStatus=function(){var e,t,n,r,i,s,o,a,f,c,p,v,m,g,y,b,w,E,S;m=function(){var e,t;e=this.effects,t=[];for(r in e){if(!h.call(e,r))continue;a=e[r],a.status.degree<1&&t.push(r)}return t}.call(this);for(f=0,p=m.length;f<p;f++)o=m[f],delete this.effects[o];s=function(){var e,n;e=this.effects,n=[];for(r in e){if(!h.call(e,r))continue;t=e[r],n.push(t.status.key)}return n}.call(this),e=u.combinedStatus(s),this.status=e.statuses,this.statusDegree=e.degree,this.clearModifiers(),(g=this.attack)!=null&&g.clearModifiers(),(y=this.defense)!=null&&y.clearModifiers(),b=e.modifiers,S=[];for(c=0,v=b.length;c<v;c++)i=b[c],n=l.makeArray(i.group),d.call(n,"ALL")>=0&&(n=["character","attack","defense"]),d.call(n,"character")>=0&&this.addModifier(i.property,i.modifier),d.call(n,"attack")>=0&&(w=this.attack)!=null&&w.addModifier(i.property,i.modifier),d.call(n,"defense")>=0?S.push((E=this.defense)!=null?E.addModifier(i.property,i.modifier):void 0):S.push(void 0);return S},t.prototype.attack=function(e){if(this.attack==null||(e!=null?e.defense:void 0)==null)return;return e.applyHit(this.attack.attack(e.defense))},t.prototype.applyHit=function(e){var t,n,i,s,o,a;if(e.degree<0)return;s=this.defense.resistHit(e,this.stress);if(s.stress<1&&(s.status==null||s.status.degree<1))return;this.stress+=s.stress;if(s.status==null||s.status.degree<1)return;n=this.effects[e.attack.uid]!=null?this.effects[e.attack.uid].status:u.getStatus("normal"),i=s.status,t=e.attack.cumulativeStatuses,(o=n.key,d.call(t,o)>=0)&&(a=i.key,d.call(t,a)>=0)&&(i=e.attack.statusByDegree(n.degree+i.degree));if(i.degree>n.degree)return addEffect(new r({attack:e.attack,defense:s.defense,status:i}))},t.prototype.addEffect=function(e){return this.effects[e.attack.uid]=e,this.updateStatus()},t.prototype.endRoundRecovery=function(){var e,t,n,r,i;e=!1,i=this.effects;for(n in i){if(!h.call(i,n))continue;t=i[n];if(!t.attack.isStatusRecovery||t.status.degree<1||t.status.degree>2)continue;r=this.checkDegree(t.attack.rank+10,this.rollCheck(t.defense.save)),r>0?(e=!0,t.status=u.getStatus("normal")):t.attack.isProgressive&&(e=!0,t.status=t.attack.statusByDegree(t.status.degree+1))}if(e)return this.updateStatus},t}(s),module.exports={Character:n,CharacterEffect:r},s=require("./modifiable.coffee").Modifiable,l=require("./utils.coffee").utils,u=require("../src/status.coffee").Status,o=function(e){function t(e){var n;e==null&&(e={}),n={defense:null,d20:0,roll:0,degree:4,stress:0,status:u.getStatus("normal")},t.__super__.constructor.call(this,null,n,e)}return p(t,e),t}(s),i=function(e){function t(e){var n;e==null&&(e={}),n={value:10,save:10,impervious:null},t.__super__.constructor.call(this,n,null,e)}return p(t,e),t.prototype.resistHit=function(e,t){var n,r;r=new o({defense:this});if(e.degree<1)return r;n=e.damage;if(this.impervious!=null&&this.impervious>=e.damageImpervious){if(e.attack.penetrating==null||e.attack.penetrating<1)return r;n=Math.min(e.attack.penetrating,e.damage)}return r.d20=this.rollCheck(),r.roll=r.d20+this.save-t,r.degree=this.checkDegree(n+10,r.roll),r.d20===20&&(r.degree=l.increaseDegree(r.degree)),e.attack.isCauseStress&&r.degree<=1&&(r.stress=1),r.status=e.attack.statusByResistDegree(r.degree),r},t}(s),module.exports={Defense:i,ResistResult:o},l=require("./utils.coffee").utils,c=require("underscore"),s=function(){function e(e,t,n){this.rollCheck=v(this.rollCheck,this),this._applyModifiers=v(this._applyModifiers,this),this._modifiers={rollCheck:[]},this._modifiable(e),this._properties(t),this._values(n),this.uid=c.uniqueId("uid_")}return e.prototype._modifiable=function(e){var t,n,r,i=this;if(e!=null){r=[];for(t in e){if(!h.call(e,t))continue;n=e[t],r.push(function(e,t){return i._modifiers[e]=[],i["_"+e]=t,Object.defineProperty(i,e,{get:function(){return this._applyModifiers(e,this["_"+e])},set:function(t){return this["_"+e]=t},enumerable:!0,configurable:!0})}(t,n))}return r}},e.prototype._properties=function(e){var t,n,r,i=this;if(e!=null){r=[];for(t in e){if(!h.call(e,t))continue;n=e[t],r.push(function(e,t){return i[e]=t}(t,n))}return r}},e.prototype._values=function(e){var t,n,r,i=this;if(e!=null){r=[];for(t in e){if(!h.call(e,t))continue;n=e[t],r.push(function(e,t){if(!Object.prototype.hasOwnProperty.call(i,e))throw new Error("Invalid property '"+e+"'");return i[e]=t}(t,n))}return r}},e.prototype._applyModifiers=function(e,t){var n,r,i,s;if(this._modifiers[e]!=null){s=this._modifiers[e];for(r=0,i=s.length;r<i;r++)n=s[r],t=n.call(this,t)}return t},e.prototype.addModifier=function(e,t){if(this._modifiers[e]==null)throw new Error("'"+e+"' cannot be modified");return this._modifiers[e].push(t)},e.prototype.clearModifiers=function(e){var t,n,r,i;if(e==null){r=this._modifiers,i=[];for(t in r){if(!h.call(r,t))continue;n=r[t],i.push(this.clearModifiers(t))}return i}if(this._modifiers[e]!=null)return this._modifiers[e]=[]},e.prototype.rollCheck=function(e){return e==null&&(e=0),this._applyModifiers("rollCheck",l.rollD20(e))},e.prototype.checkDegree=function(e,t){return l.checkDegree(e,t)},e}(),module.exports={Modifiable:s},c=require("underscore"),a=function(){function e(e,t,n,r){this.group=e,this.property=t,this.modifier=n,this.description=r}return e}(),u=function(){function e(t){var n;t==null&&(t={}),n={key:"normal",degree:0,recovery:!1,replace:null,modifiers:null},t=c.extend(n,t),this.key=t.key,this.degree=t.degree,this.recovery=t.recovery,this.replace=t.replace,this.modifiers=t.modifiers,e.STATUSES[this.key]=this}return e.STATUSES=null,e.getStatus=function(t){var n;if(t instanceof e)return t;if(c.isString(t)){n=e.STATUSES[t];if(n==null)throw new Error("Invalid status '"+t+"'");return n}return null},e.combinedStatus=function(t){var n,r,i,s,o,u,f,l,p,d;f=e._doExpandStatuses(t),o=[],n=[];for(r in f){if(!h.call(f,r))continue;u=f[r],n.push(u.degree);if(c.isArray(u.modifiers)){d=u.modifiers;for(l=0,p=d.length;l<p;l++)i=d[l],c.isArray(i)&&o.push(function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t);return Object(i)===i?i:r}(a,i,function(){}))}}return s=n.length>0?Math.max.apply(Math,n):0,{statuses:f,modifiers:o,degree:s}},e.expandStatuses=function(t){return e.combinedStatus(t).statuses},e.allModifiers=function(t){return e.combinedStatus(t).modifiers},e.degree=function(t){return e.combinedStatus(t).degree},e._doExpandStatuses=function(t){var n,r,i,s,o,u,a,f,l,p,d;c.isObject(t&&!c.isArray(t&&!c.isFunction(t)))&&(t=c.values(t)),c.isArray(t)||(t=[t]),s={};for(a=0,l=t.length;a<l;a++){u=t[a],o=e.getStatus(u);if(o==null||s[o.key]!=null)continue;s[o.key]=o,c.isArray(o.modifiers)&&(s=c.extend(s,e._doExpandStatuses(o.modifiers)))}for(n in s){if(!h.call(s,n))continue;u=s[n],u.replace!=null&&(i=u.replace)}if(i!=null){d=c.flatten(i);for(f=0,p=d.length;f<p;f++)r=d[f],delete s[r]}return c.keys(s).length<1&&(s.normal=e.getStatus("normal")),s["normal"]!=null&&c.keys(s).length>1&&delete s.normal,s},e._init=function(){var t,n,r,i,s;if(e.STATUSES!==null)return;e.STATUSES={},n=[{key:"normal",degree:0,recovery:!1,replace:null,modifiers:null},{key:"compelled",degree:2,recovery:!1,replace:null,modifiers:["actionPartial","actionsControlled"]},{key:"controlled",degree:3,recovery:!1,replace:["compelled"],modifiers:["actionsControlled"]},{key:"dazed",degree:1,recovery:!1,replace:null,modifiers:["actionPartial"]},{key:"debilitated",degree:3,recovery:!1,replace:["disabled","weakened"],modifiers:["actionNone"]},{key:"defenseless",degree:2,recovery:!1,replace:["vulnerable"],modifiers:[["defense","value",function(e){return 0},"defenseless"]]},{key:"disabled",degree:2,recovery:!1,replace:["impaired"],modifiers:[["ALL","rollCheck",function(e){return e-5},"disabled; -5 to checks"]]},{key:"fatigued",degree:1,recovery:!1,replace:null,modifiers:["hindered"]},{key:"hindered",degree:1,recovery:!1,replace:null,modifiers:[["character","speed",function(e){return e-1},"hindered: -1 speed"]]},{key:"immobile",degree:2,recovery:!1,replace:["hindered"],modifiers:[["character","speed",function(e){return null},"immoble: no speed"]]},{key:"impaired",degree:1,recovery:!1,replace:null,modifiers:[["ALL","rollCheck",function(e){return e-2},"impaired; -2 to checks"]]},{key:"stunned",degree:2,recovery:!1,replace:["dazed"],modifiers:["actionNone"]},{key:"transformed",degree:3,recovery:!1,replace:null,modifiers:["actionNone"]},{key:"unaware",degree:3,recovery:!1,replace:null,modifiers:["actionNone"]},{key:"vulnerable",degree:1,recovery:!1,replace:null,modifiers:[["defense","value",function(e){return Math.ceil(e/2)},"vulnerable: 1/2 defense"]]},{key:"weakened",degree:1,recovery:!1,replace:null,modifiers:null},{key:"asleep",degree:3,recovery:!1,replace:null,modifiers:["defenseless","stunned","unaware"]},{key:"blind",degree:2,recovery:!1,replace:null,modifiers:["hindered","unaware","vulnerable","impaired"]},{key:"bound",degree:2,recovery:!1,replace:null,modifiers:["defenseless","immobile","impaired"]},{key:"deaf",degree:2,recovery:!1,replace:null,modifiers:["unaware"]},{key:"dying",degree:4,recovery:!1,replace:null,modifiers:["incapacitated"]},{key:"entranced",degree:1,recovery:!0,replace:null,modifiers:["actionNone"]},{key:"exhausted",degree:2,recovery:!1,replace:["fatigued"],modifiers:["impaired","hindered"]},{key:"incapacitated",degree:3,recovery:!1,replace:null,modifiers:["defenseless","stunned","unaware","prone"]},{key:"paralyzed",degree:3,recovery:!1,replace:null,modifiers:["defenseless","immobile","stunned"]},{key:"prone",degree:2,recovery:!1,replace:null,modifiers:["hindered",["defense","value",function(e){return e-5},"prone: -5 defense"]]},{key:"restrained",degree:2,recovery:!1,replace:null,modifiers:["hindered","vulnerable"]},{key:"staggered",degree:2,recovery:!1,replace:null,modifiers:["dazed","hindered"]},{key:"suprised",degree:1,recovery:!0,replace:null,modifiers:["stunned","vulnerable"]},{key:"actionPartial",degree:0,recovery:!1,replace:null,modifiers:[["character","actions",function(e){return"partial"},"partial actions"]]},{key:"actionNone",degree:0,recovery:!1,replace:["actionPartial"],modifiers:[["character","actions",function(e){return"none"},"no actions"]]},{key:"actionsControlled",degree:0,recovery:!1,replace:null,modifiers:[["character","isControlled",function(e){return!0},"actions controlled"]]}],s=[];for(r=0,i=n.length;r<i;r++)t=n[r],s.push(new e(t));return s},e}(),u._init(),module.exports={Status:u,StatusModifier:a},c=require("underscore"),f=function(){function e(){}return e.rollD20=function(e){return e==null&&(e=0),Math.floor(Math.random()*20)+1+e},e.checkDegree=function(e,t){var n;return n=t-e,Math.floor(n/5)+(n<0?0:1)},e.increaseDegree=function(e,t){var n;return t==null&&(t=1),n=e<0,e+=t,n&&e>=0?e+1:e},e.makeArray=function(e){return e==null?[]:c.isArray(e)?e:[e]},e}(),module.exports={utils:f}}).call(this);